# 创世块

## JSON文件

1. **手动创建：**

```json
{
  "config": {
    "chainId": 666,
    "homesteadBlock": 0,
    "eip150Block": 0,
    "eip150Hash": "0x0000000000000000000000000000000000000000000000000000000000000000",
    "eip155Block": 0,
    "eip158Block": 0,
    "byzantiumBlock": 0,
    "constantinopleBlock": 0,
    "petersburgBlock": 0,
    "istanbulBlock": 0,
    "ethash": {}
  },
  "nonce": "0x0",
  "timestamp": "0x5ddf8f3e",
  "extraData": "0x0000000000000000000000000000000000000000000000000000000000000000",
  "gasLimit": "0x47b760",
  "difficulty": "0x00002",
  "mixHash": "0x0000000000000000000000000000000000000000000000000000000000000000",
  "coinbase": "0x0000000000000000000000000000000000000000",
  "alloc": { },
  "number": "0x0",
  "gasUsed": "0x0",
  "parentHash": "0x0000000000000000000000000000000000000000000000000000000000000000"
}
```

2. **puppeth生成：**

> puppeth是一个自动化运维管理工具，geth中自带

```json
{
    "config": {
        "chainId": 666,
        "homesteadBlock": 0,
        "eip150Block": 0,
        "eip150Hash": "0x0000000000000000000000000000000000000000000000000000000000000000",
        "eip155Block": 0,
        "eip158Block": 0,
        "byzantiumBlock": 0,
        "constantinopleBlock": 0,
        "petersburgBlock": 0,
        "istanbulBlock": 0,
        "clique": {
            "period": 15,
            "epoch": 30000
        }
    },
    "nonce": "0x0",
    "timestamp": "0x5f350a96",
    "extraData": "0x00000000000000000000000000000000000000000000000000000000000000006f25fcf724d93a58da537489eeb295bb09f6f1648ab5ddc2708916dfbd6f8cb07999d78bf41c57940000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
    "gasLimit": "0x47b760",
    "difficulty": "0x1",
    "mixHash": "0x0000000000000000000000000000000000000000000000000000000000000000",
    "coinbase": "0x0000000000000000000000000000000000000000",
    "alloc": {
        "6f25fcf724d93a58da537489eeb295bb09f6f164": {
            "balance": "0x1000000000000000000"
        },
        "8ab5ddc2708916dfbd6f8cb07999d78bf41c5794": {
            "balance": "0x1000000000000000000"
        }
    },
    "number": "0x0",
    "gasUsed": "0x0",
    "parentHash": "0x0000000000000000000000000000000000000000000000000000000000000000"
}
```

**步骤：**

```stylus
//运行puppeth命令后会提示你输入私链的名称。
Please specify a network name to administer (no spaces, please)
> My-Private-Chain
```

```stylus
What would you like to do? (default = stats)
 1. Show network stats
 2. Configure new genesis
 3. Track new remote server
 4. Deploy network components
> 2
```

```stylus
//选择共识机制
Which consensus engine to use? (default = clique)
 1. Ethash - proof-of-work
 2. Clique - proof-of-authority
> 
```

- Ethash - proof-of-work(POW) ：工作量证明，通过算力达成共识 （以太坊就是使用这种方式）

- Clique - proof-of-authority(POA):  权威证明、通过预先设定的权威节点负责达成共识 (不消耗算力，一般用于私有链测试开发)

  > 如果选择Pow的共识方法,直接输入1，回车即可。
  >
  > 如果选择PoA的共识方法，输入2后会提示让你选择处快的间隔时间，一般测试开发使用可以设置相对的将出块时间设置较少5秒即可，然后会让你选择哪个账户来作为权威生成区块(至少有一个)

```stylus
How many seconds should blocks take? (default = 15)
> 5
Which accounts are allowed to seal? (mandatory at least one)
>0x0cfd3ab46d552d30f8b1c4f1b08a90f40192de97
```

```stylus
//选择好共识机制后会让你指定给那些账号初始化ether(至少有一个)，输入我们刚才创建的账户地址回车即可。
Which accounts should be pre-funded? (advisable at least one)
> 0xc43881d20bb2a2b6d72801b4bc04cdcc35950a8b
```

```stylus
//选择输入私有链的网络ID，任意数字即可（不能为1，1是公链），也可以不输入会给定一个随机数作为私有链的网络ID
Specify your chain/network ID if you want an explicit one (default = random)
> 666
```

```stylus
//创世区块中是允许你输入一些个人信息的，可以选择输入也可以直接按回车跳过
Anything fun to embed into the genesis block? (max 32 bytes)
>Test Private Chain
```

```stylus
What would you like to do? (default = stats)
 1. Show network stats
 2. Manage existing genesis
 3. Track new remote server
 4. Deploy network components
> 2
```

```stylus
 1. Modify existing fork rules
 2. Export genesis configuration
> 2
```

```stylus
//选择导出创世区块配置文件的保存路径，可以保存到当前目录，直接按回车即可
Which file to save the genesis into? (default = my-private-chain.json)
> 
INFO [02-09|14:56:33] Exported existing genesis block 

//完成创世区块配置，直接退出puppeth即可。
```

## 文件说明

### 1. chainID

链ID，在全球须唯一，各个链之间ID不同。ETH的ID是1， ETC的id是61。已经在用的ID有：

| `CHAIN_ID` | Chain(s)                      |
| :--------- | :---------------------------- |
| 1          | Ethereum mainnet              |
| 2          | Expanse mainnet               |
| 3          | Ropsten                       |
| 4          | Rinkeby                       |
| 30         | Rootstock mainnet             |
| 31         | Rootstock testnet             |
| 42         | Kovan                         |
| 61         | Ethereum Classic mainnet      |
| 62         | Ethereum Classic testnet      |
| 1337       | Geth private chains (default) |

### 2. 硬分叉设置

| 参数名称       | 参数描述                                 |
| -------------- | ---------------------------------------- |
| homesteadBlock | homesteadBlock硬分叉的高度，设置为0 即可 |
| eip150Block    | EIP 150硬分叉的高度，设置为0即可。       |
| eip150Hash     | EIP 150的hash值， 设置为0即可。          |
| eip155Block    | EIP 155硬分叉的高度，设置为0即可。       |
| eip158Block    | EIP 158硬分叉的高度，设置为0即可。       |
| byzantiumBlock | Byzantium硬分叉的高度，设置为0即可。     |

### 3. POA 挖矿参数

以太坊目前有ethash和clique两个共识引擎,其中ethash是用于正式网络的PoW(proof-of-work)共识引擎,clique是用于测试网络的PoA(proof-of-authority)共识引擎

| 参数名称   | 参数描述                                                     |
| ---------- | ------------------------------------------------------------ |
| clique     | period： 生成块的时间，15秒。   epoch： 生成DAG的大小，默认都是3万。 |
|            |                                                              |
| mixhash    | 与nonce配合用于挖矿,由上一个区块的一部分生成的hash。注意他和nonce的设置需要满足以太坊的Yellow paper,4.3.4. Block Header Validity, (44)章节所描述的条件。 |
| nonce      | nonce就是一个64位随机数,用于挖矿,注意他和mixhash的设置需要满足以太坊的Yellow paper, 4.3.4. Block HeaderValidity, (4)章节所描述的条件。 |
| difficulty | 设置当前区块的难度,如果难度过大, cpu挖矿就很难,这里设置较小难度 |
| alloc      | 用来预置账号以及账号的以太币数量,因为私有链挖矿比较容易,所以我们不需要预置有币的账号,需要的时候自己创建即可以。 |
| coinbase   | 矿工的账号,在这里不设置                                      |
| timestamp  | 设置创世块的时间戳                                           |
| parentHash | 上一个区块的hash值,因为是创世块,所以这个值是0                |
| extraData  | 附加信息,随便填,可以填你的个性信息；在POA机制下，这里写的是预分配账户 |
| gasLimit   | 该值设置对GAS的消耗总量限制,用来限制一个区块能包含的交易信息总和,因为我们是私有链,所以填最大。 |

# 创建私有链

1. **安装geth**

```stylus
brew install geth
```

2. **创建节点目录**

```stylus
mkdir eth
cd eth
mkdir enode1
mkdir enode2
```

3. **创建账号（POA共识机制下需要）**

```stylus
geth --datadir ./enode1/data account new
geth --datadir ./enode1/data account new
```

4. **初始化节点**

```stylus
geth --datadir enode1/data init my-private-chain.json 
geth --datadir enode2/data init my-private-chain.json 
```

初始成功后会在数据目录data下生产geth和keystore两个文件夹

> geth目录：保存链上的区块数据
>
> keystore目录：保存链上的账户数据

<img src="https://tva1.sinaimg.cn/large/007S8ZIlly1ghpl8bgnodj30ah09idh5.jpg" alt="EC5FC340-ECBA-4D70-A3C4-62506E0B4C88"  align="left"/>

5. **启动节点**

```shell
geth --rpc --nodiscover --datadir ./enode1/data --port 30303 --rpc --rpcport 8545 --rpcapi "eth,net,web3" --rpccorsdomain "*" --networkid 666 --ipcdisable console --allow-insecure-unlock
```

> --allow-insecure-unlock：允许不安全解锁，开启后控制台内才可以对账户解锁

```sh
geth attach rpc:http://127.0.0.1:8545 
#连接geth javaScript控制台，也可以：geth console 2>>geth.log
```

| 参数            | 参数描述                                                     |
| --------------- | ------------------------------------------------------------ |
| --identity      | 区块链的标示，随便填写，用于标示目前网络的名字               |
| --datadir       | 私有链数据存放目录，包括Ethereum使用的Leveldb数据            |
| --port          | geth的网络端口，默认是30303,如果一台电脑上多个节点一定设置不同的端口 |
| --rpc           | 启动rpc通信，可以进行智能合约的部署和调试                    |
| --rpcaddr       | 指定HTTP-RPC服务监听地址，默认为“localhost”                  |
| --rpcapi        | 设置允许连接的rpc的客户端，一般为db,eth,net,web3             |
| --rpcport       | 指定允许连接的rpc服务监听端口，默认为8545,如果一台电脑上多个节点一定设置不同的端口 |
| --rpccorsdomain | 设置哪些URL可以连接你的RPC接口。                             |
| --networkid     | 设置当前区块链的网络ID，用于区分不同的网络，1代表是公链，与创世块的chainId相同 |
| --nat           | 根据自己网络情况选择是否添加                                 |
| --nodiscover    | 关闭自动连接节点，但是可以手动添加节点，在搭建私有链时，为避免其他节点连入私有链，可以使用该命令 |
| --ipcdisable    | 不能使用IPC连接                                              |
| --etherbase     | 指定旷工账号，默认为keystore中的首个账号                     |
| --mine          | 开启挖矿，默认为CPU挖矿                                      |
| --minerthreads  | 挖矿占用CPU的线程数，默认为4                                 |
| --maxpeers      | 设置允许最大连接节点数目，默认为25                           |
| console         | 启动命令行模式，可以在Geth中执行命令                         |

6. **控制台操作**

这是一个交互式的 JavaScript 执行环境，在这里面可以执行 JavaScript 代码。这个环境里内置了一些用来操作以太坊的 JavaScript 对象，可以直接。

**主要对象：**

> eth：包含一些跟操作区块链相关的方法；
>
> net：包含一些查看p2p网络状态的方法；
>
> admin：包含一些与管理节点相关的方法；
>
> miner：包含启动&停止挖矿的一些方法；
>
> personal：主要包含一些管理账户的方法；
>
> txpool：包含一些查看交易内存池的方法；
>
> web3：包含了以上对象，还包含一些单位换算的方法。

**账户相关：**

```stylus
eth.accounts               // 查询账户列表
personal.listAccounts      // 查询账户列表
eth.accounts[0]			   // 查看账户列表的第一个账户
personal.listAccounts[0]   // 查看账户列表的第一个账户
personal.newAccount("xxx") // 新建账户，xxx为账户密码，也可为空
eth.coinbase          	   // 节点挖矿的账户地址，默认为账户列表的第一个账户
miner.setEtherbase(xxx)    // 设置挖矿的账户，xxx为账户地址
eth.getBalance("xxx")      // 查看对应账户的余额，xxx为账户地址
			               // 返回值的单位是wei，wei是以太币的最小单位，1个以太币=10^18wei。
web3.fromWei()             // 将返回值换算成以太币
web3.fromWei(eth.getBalance(eth.account[0]))   
```

**交易相关：**

```stylus
//解锁账户（账户，密码，解锁时间【单位是秒】）
personal.unlockAccount(eth.accounts[0],"123",6000)
//发送转账交易，返回交易的哈希
eth.sendTransaction({from:eth.accounts[0],to:"0xdb2e9d8b44b8e52b276cb3b81764076d77bea6fb",value:web3.toWei(0.005, "ether")})
返回："0x70b014b7ded02aadb2e78c48e1ab8762694ffb82d0189e180b14318ec8455cd7"
//查看交易信息
eth.pendingTransactions
// 查看交易信息
eth.getTransaction("交易的哈希") 
//查看交易池，查看当前交易的待处理状态
txpool.status        
```

**挖矿相关：**

```stylus
//开始挖矿
//参数表示挖矿使用的线程数。
//第一次启动挖矿会先生成挖矿所需的DAG文件，这个过程有点慢，等进度达到100%后，就会开始挖矿，此时屏幕会被挖矿信息刷屏。
miner.start(1)              
//挖到第一个区块即停止挖矿
admin.sleepBlocks(1)
// 停止挖矿
miner.stop()               
//组合输入
miner.start(1);admin.sleepBlocks(1);miner.stop()
```

**区块相关：**

```stylus
// 查看链上区块数量
eth.blockNumber
// 根据区块号查看区块信息，xxx为区块号
eth.getBlock(xxx)          
```

**节点相关：**

```stylus
// 查看节点信息
admin.nodeInfo             
// 查看节点enode信息
admin.nodeInfo.enode
// 添加节点
admin.addPeer("enode://52ee8fd33d8d37093b5be9171b209140ebe34e70a6bd286a998d0d1128780fdd18f4cac99b67cd8615e04214e405340d5afe41bb5e8426a01b00dc47a9a2e9ae@127.0.0.1:30304?discport=0")
//查看网络中已连接节点信息
admin.peers
// 查看网络中已连接节点数量
net.peerCount
```

**遇到问题：**

```stylus
1. //“Signed recently, must wait for others”问题:

如：在配置创世区块配置文件的时候 , 指定了2个有签名权限的账户 , 分别属于2个节点 。
需要登录第2个节点控制台 , 启动挖矿。如果节点连接没有问题 , 2个节点开始刷屏 , 那么说明挖矿启动成功了。 
如果第2个节点也停留在 “Signed recently, must wait for others” . 说明节点没有连通。

原则 : 在网络中 , 任何更改都需要由50%+1个节点提出 , 以使其生效 。对于2个签名者 , 50%+1实际上是2 , 所以需要让第2个签名者的节点也启动挖矿。
```

