# 网络架构

## 协议总览

![20140924202143732](https://tva1.sinaimg.cn/large/007S8ZIlly1ggg3omzk1hg30u016itf2.gif)

## 协议定义

![img](https://tva1.sinaimg.cn/large/007S8ZIlly1ghnwx4mw5fj30f90amgng.jpg)

## 各模块说明

![img](https://tva1.sinaimg.cn/large/007S8ZIlly1ghnwxerrv2j30dq0l478t.jpg)

## TCP/IP模型

![img](https://tva1.sinaimg.cn/large/007S8ZIlly1ghnwzv8ygej30ju0880tm.jpg)

# TCP协议

## 总览

TCP(Transmission Control Protocol 传输控制协议)是一种面向连接的、可靠的， 基于IP的传输层协议。TCP在IP报文的协议号是6。TCP是一个超级麻烦的协议，而它又是互联网的基础。

TCP是面向连接的，无论哪一方向另一方发送数据之前，都必须先在双方之间建立一条连接。在TCP/IP协议中，TCP 协议提供可靠的连接服务，连接是通过三次握手进行初始化的。三次握手的目的是同步连接双方的序列号和确认号并交换 TCP窗口大小信息。如下图TCP的通信过程所示：

![img](https://tva1.sinaimg.cn/large/007S8ZIlly1ghny5pke0vj30e80h0tfo.jpg)

位码即TCP标志位,有6种标示:

- SYN(synchronous建立联机)
- ACK(acknowledgement 确认)
- PSH(push传送)
- FIN(finish结束)
- RST(reset重置)
- URG(urgent紧急)
- Sequence number(顺序号码)
- Acknowledge number(确认号码)

　　## 报文格式

![img](https://tva1.sinaimg.cn/large/007S8ZIlly1ghny3s2y2xj30hh0ab3zp.jpg)

![img](https://tva1.sinaimg.cn/large/007S8ZIlly1ghny3ohpshj30go0ak0t3.jpg)

**Source Port和Destination Port：**分别占用16位，表示源端口号和目的端口号;用于区别主机中的不同进程， 而IP地址是用来区分不同的主机的，源端口号和目的端口号配合上IP首部中的源IP地址和目的IP地址就能唯一 的确定一个TCP连接；

**Sequence Number：**用来标识从TCP发端向TCP收端发送的数据字节流，它表示在这个报文段中的的第一个数据 字节在数据流中的序号;主要用来解决网络报乱序的问题；

**Acknowledgment Number：**32位确认序列号包含发送确认的一端所期望收到的下一个序号，因此，确认序号应 当是上次已成功收到数据字节序号加1。不过，只有当标志位中的ACK标志(下面介绍)为1时该确认序列号的字 段才有效。主要用来解决不丢包的问题；

**Offset：**给出首部中32 bit字的数目，需要这个值是因为任选字段的长度是可变的。这个字段占4bit(最多能 表示15个32bit的的字，即4*15=60个字节的首部长度)，因此TCP最多有60字节的首部。然而，没有任选字段， 正常的长度是20字节；

**TCP Flags:**TCP首部中有6个标志比特，它们中的多个可同时被设置为1，主要是用于操控TCP的状态机的，依次 为URG，ACK，PSH，RST，SYN，FIN。

**URG：**此标志表示TCP包的紧急指针域(后面马上就要说到)有效，用来保证TCP连接不被中断，并且督促 中间层设备要尽快处理这些数据；

**ACK：**此标志表示应答域有效，就是说前面所说的TCP应答号将会包含在TCP数据包中;有两个取值：0和1， 为1的时候表示应答域有效，反之为0；

**PSH：**这个标志位表示Push操作。所谓Push操作就是指在数据包到达接收端以后，立即传送给应用程序， 而不是在缓冲区中排队；

**RST：**这个标志表示连接复位请求。用来复位那些产生错误的连接，也被用来拒绝错误和非法的数据包；

**SYN：**表示同步序号，用来建立连接。SYN标志位和ACK标志位搭配使用，当连接请求的时候，SYN=1， ACK=0；连接被响应的时候，SYN=1，ACK=1；这个标志的数据包经常被用来进行端口扫描。扫描者发送 一个只有SYN的数据包，如果对方主机响应了一个数据包回来 ，就表明这台主机存在这个端口;但是由于这 种扫描方式只是进行TCP三次握手的第一次握手，因此这种扫描的成功表示被扫描的机器不很安全，一台安全 的主机将会强制要求一个连接严格的进行TCP的三次握手；

**Window：**窗口大小，也就是有名的滑动窗口，用来进行流量控制。这是一个复杂的问题，这里暂不讨论。

　　## 三次握手

> **三次握手目的：确认两边都可接受并发送数据**
>
> ```css
> 1. A发送给B：确认A可以发送、B可以接收
> 2. B发送给A：确认B可以发送、A可以接收；第一步得到确认
> 3. A发送给B：第二步得到确认
> ```
>
> 
>**第一次握手：**建立连接。客户端发送连接请求报文段，将SYN位置为1，Sequence Number为x;然后，客户端进入SYN_SEND状态，等待服务器的确认。（客户的建立连接并等待确认）
>
> 
>**第二次握手：**服务器收到SYN报文段。服务器收到客户端的SYN报文段，需要对这个SYN报文段进行确认，设置Acknowledgment Number为x+1(Sequence Number+1);同时，自己自己还要发送SYN请求信息，将SYN位置为1，Sequence Number为y;服务器端将上述所有信息放到一个报文段(即SYN+ACK报文段)中，一并发送给客户端，此时服务器进入SYN_RECV状态。（服务器端发送相关报文段信息并等待连接）
>
> **第三次握手：**客户端收到服务器的SYN+ACK报文段。然后将Acknowledgment Number设置为y+1，向服务器发送ACK报文段，这个报文段发送完毕以后，客户端和服务器端都进入ESTABLISHED状态，完成TCP三次握手。（客户端接收到服务端信息并实现连接）

## 四次分手

> **三次握手目的：确认两边数据都已发送完毕并确认断开连接**
>
> < 类比挂电话过程：我说完了，挂？→我也说完了，挂吧？→好，拜拜→bye >
>
> ```css
> 1. A发送给B：A发送完毕、A可以断开吗？
> 2. B发送给A：B发送完毕、A可以断开
> 3. B发送给A：B可以断开吗？
> 4. A发送给B：B可以断开
> ```
>
> **第一次分手：**主机1(可以使客户端，也可以是服务器端)，设置Sequence Number和Acknowledgment Number，向主机2发送一个FIN报文段;此时，主机1进入FIN_WAIT_1状态;这表示主机1没有数据要发送给主机2了。（一方数据发送完成）
>
> **第二次分手：**主机2收到了主机1发送的FIN报文段，向主机1回一个ACK报文段，Acknowledgment Number为Sequence Number加1;主机1进入FIN_WAIT_2状态;主机2告诉主机1，我也没有数据要发送了，可以进行关闭连接了。（另一方数据发送完成）
>
> **第三次分手：**主机2向主机1发送FIN报文段，请求关闭连接，同时主机2进入CLOSE_WAIT状态。（请求关闭连接并等待）
>
> **第四次分手：**主机1收到主机2发送的FIN报文段，向主机2发送ACK报文段，然后主机1进入TIME_WAIT状态;主机2收到主机1的ACK报文段以后，就关闭连接;此时，主机1等待2MSL后依然没有收到回复，则证明Server端已正常关闭，那好，主机1也可以关闭连接了。（关闭连接）

# UDP协议

## 简介
　　UDP (User Datagram Protocol 用户数据报协议)，是一种无连接的，基于IP的传输层协议，提供面向事务的简单不可靠信息传送服务。UDP在IP报文的协议号是17。

## 报文格式

　　与TCP协议不同，UDP协议是非面向连接的不可靠协议，因此没有了SYN等处理两端等待或连接的报文段，相比之下，UDP的报文格式更为简单，主要由报文头（由均16位的源端口号、目的端口号、UDP长度和UDP校验和组成）和具体传输数据组成。如图所示：

![img](https://img-blog.csdn.net/20180702155720810?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2NDU4MjY4/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)

**UDP长度：**UDP报文的整个大小，最小为8个字节（16*4位）（仅为首部）。

**UDP检验和：**在进行检验和计算时，会添加一个伪首部一起进行运算。伪首部（占用12个字节）为：4个字节的源IP地址、4个字节的目的IP地址、1个字节的0、一个字节的数字17、以及占用2个字节UDP长度。这个伪首部不是报文的真正首部，只是引入为了计算校验和。相对于IP协议的只计算首部，UDP检验和会把首部和数据一起进行校验。接收端进行的校验和与UDP报文中的校验和相与，如果无差错应该全为1。如果有误，则将报文丢弃或者发给应用层、并附上差错警告。

## 应用


在选择使用协议的时候，选择UDP必须要谨慎。在网络质量令人十分不满意的环境下，UDP协议数据包丢失会比较严重。但是由于UDP的特性：它不属于连接型协议，因而具有资源消耗小，处理速度快的优点，所以通常音频、视频和普通数据在传送时使用UDP较多，因为它们即使偶尔丢失一两个数据包，也不会对接收结果产生太大影响。比如我们聊天用的QQ就是使用的UDP协议。

# 网络的发展

　　**计算机与网络的发展过程**

![img](https://tva1.sinaimg.cn/large/007S8ZIlly1ghnx9aq58rj30f906oaam.jpg)

**计算机的模式变化**
　　起初的计算机主要以“单机”形式存在，计算机之间没有通信可言，而网络的出现才真正让计算机变得与以往的工具不同，信息的共享和交流让计算机成为划时代的产物。网络按照规模可划分为：

局域网（LAN）：局域网是某一区域内由多台计算机互联成的计算机组。一般在几公里范围内。

广域网（WAN）：广域网的范围很大，几十公里到几千公里，可以是一个区域的计算机网也可能是整个国家的计算机网。

注：我们常见的WLAN是LAN的一种，称为无线局域网。在无线局域网WLAN发明之前，人们要想通过网络进行联络和通信，必须使用物理线缆-铜绞线或光纤进行物理线路连接，但这样的局域网转载和拆卸都很麻烦。随着网络的发展，人民利用射频（Radio Frequency； RF）的技术，使用电磁波进行网络架构，实现了无线局域网互联，让信息随身化。

# IP地址

**10.0.0.1/24**

既可用地址：10.0.0.1~10.0.0.255

> / 8 = 255.0.0.0
>
> / 16 = 255.255.0.0
>
> / 24 = 255.255.255.0
>
> / 32 = 255.255.255.255

